<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name=keywords content="Частная коллекция многолетних растений для средней полосы,  растения почтой, растения для сада, коллекция декоративных растений, декоративные растения, сад природного облика,  редкие растения, коллекционные растения, растения для тенистых мест, неприхотливые растения, почвопокровные растения, лианы, декоративно-лиственные растения, лекарственные растения, папоротники, злаки, реализация декоративных растений, оптовая реализация декоративных растений, цветущие кустарники, цветущие растения, цветы купить, продажа растений, цветы для сада, посадочный материал, коллекционные растения, растения у коллекционеров, коллекция флоксов, коллекция пионов, коллекция лилейников, коллекция хост, коллекционные хосты">
	<title>Ассортимент на 2026 год - Коллекция Декоративных Культур</title>

    <script type="text/javascript" src="/js/prototype.js"></script>
    <script type="text/javascript" src="/js/scriptaculous.js?load=effects,builder"></script>
    <script type="text/javascript" src="/js/lightbox.js"></script>
    <script type="text/javascript" src="/js/menu.js" defer></script>

    <link rel="stylesheet" href="/css/style.css" type="text/css"/>
	<link rel="stylesheet" href="/css/lightbox.css" type="text/css" media="screen" />

    <style>
        .empty-cart {
            text-align: center;
            font-size: 18px;
            margin-top: 20px;
        }
        .remove-item {
            background-color: #FF9999;
            border: 1px solid #000;
            padding: 5px 10px;
            cursor: pointer;
        }
        .remove-item:hover {
            background-color: #FF6666;
        }
        .quantity {
            width: 50px;
            text-align: center;
        }
        .add-to-cart {
            background-color: #99FF99;
            border: 1px solid #000;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 14px;
        }
        .add-to-cart:hover {
            background-color: #77DD77;
        }
        .quantity-input {
            width: 40px;
            text-align: center;
        }
        .added {
            font-size: 16px;
            color: green;
        }
        .catalog-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 16px;
            justify-content: center;
        }
        .catalog-tab-button {
            background-color: #99FF99;
            border: 1px solid #000;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s ease;
        }
        .catalog-tab-button:hover {
            background-color: #77DD77;
        }
        .catalog-tab-button.active {
            background-color: #5FCC5F;
            font-weight: bold;
        }
        .catalog-loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px 0;
        }
        .checkout-button {
		    background-color: #FFD700;
		    border: 1px solid #000;
		    padding: 10px 20px;
		    cursor: pointer;
		    font-size: 16px;
		    margin-top: 20px;
		}
		.checkout-button:hover {
		    background-color: #FFC107;
		}
    </style>

    <!-- Стили вложенного google sheet: -->
    <style>
        /* подзаголовки colspan; заголовки фото, код, цена */
        .waffle .s0 { background-color:#99ff99;text-align:center;font-weight:bold;vertical-align:middle;white-space:nowrap;padding:2px 3px 2px 3px; }
        /* заголовки наименование, описание */
        .waffle .s1 { background-color:#99ff99;text-align:center;font-weight:bold;vertical-align:middle;white-space:normal;overflow:hidden;word-wrap:break-word;padding:2px 3px 2px 3px; }
        /* картинки */
        .waffle .s2 { text-align:center;vertical-align:middle;white-space:nowrap;padding:0; }
        /* коды */
        .waffle .s3 { text-align:center;font-weight:bold;vertical-align:middle;white-space:nowrap;padding:2px 3px 2px 3px; }
        /* наименования */
        .waffle .s4 { text-align:left;font-weight:bold;vertical-align:middle;white-space:normal;overflow:hidden;word-wrap:break-word;padding:2px 3px 2px 3px; }
        /* описания */
        .waffle .s5 { text-align:left;vertical-align:middle;white-space:normal;overflow:hidden;word-wrap:break-word;padding:2px 3px 2px 3px; }
        /* цены */
        .waffle .s6 { text-align:center;vertical-align:middle;white-space:nowrap;padding:2px 3px 2px 3px; }
        /* наименования -- после добавления туда ссылок */
        .waffle .s7 { text-align:left;font-weight:bold;vertical-align:middle;white-space:normal;overflow:hidden;word-wrap:break-word;padding:2px 3px 2px 3px; }

        /* первая колонка - номера строк gsheet -- прячем. */
        th.row-headers-background.row-header-shim { display: none; }

        /* таблица корзины и таблица каталога -- border 1px: */
        table.waffle th,
        table.waffle td,
        #cart-table th,
        #cart-table td {
            border: 1px solid #000;
        }

        table.waffle {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        /* TODO: thead bgcolor??
            th {
                background-color: #99FF99;
            }
        */

    </style>
</head>

<body bgcolor="#CCFFCC" link="#c71585" vlink="#2f4f4f">
<table border="0" width="100%">
    <tr> <!-- начало 1й строки -->
        <td width="250px"> <!-- начало 1й ячейки -->
            <p> <img src="/Emblema.jpg" border="0" hspace="0" vspace="0"> </p>
        </td> <!-- конец 1й ячейки -->
        <td style="font-size: 40px; font-family: cursive" style="padding-left: 10px"> <!-- начало 2й ячейки -->
            <span class="green">КО</span>ллекция<br/>
            <span class="green">ДЕ</span>коративных<br/>
            <span class="green">КУ</span>льту<span class="green">Р</span>

        </td> <!-- конец 2й ячейки -->
    </tr> <!-- конец 1й строки -->

    <tr>

        <td valign="top">

            <div data-include="/partials/menu.html">
                <noscript>
                    <p>Для отображения меню включите, пожалуйста, JavaScript.</p>
                </noscript>
            </div>

            <br>

            <p style="font-size: 35px; font-family: cursive; text-align: center">
                Собственное производство
            </p>

        </td>
        <td style="text-align: center; padding-left: 10px"> <!-- Изменяемая ячейка -->

            <p style='text-align:right;font-size:15.0pt'><b>
                Дата обновления:<br>1 ноября 2025
            </b></p>

            <h2>АССОРТИМЕНТ<br/>на 2026 год</h2>

            <span style='font-size:14.0pt;margin-right:16.65pt;text-align:justify;text-indent:36.0pt'>
                <p>
                    <b><span style='color:red'>Реализация</span></b> посадочного материала производится ...... 
                </p>
                <p>
                    <b>С фотографиями растений, а также с их описанием можно ознакомиться .......... </b>
                </p>
            </span>

  
    <span><b>КОРЗИНА: </b></span><button class="add-to-cart toggle-button" onclick="toggleCart()">Развернуть корзину</button>
    <div class="cart-container" id="cart-container" style="display: none">
        <table id="cart-table" class="waffle">
            <thead>
                <tr>
                    <th class="s0">Фото</th>
                    <th class="s0">Код</th>
                    <th class="s1">Наименование</th>
                    <th class="s0">Цена, руб.</th>
                    <th class="s0">Количество</th>
                    <th class="s0">Действие</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
        <p class="empty-cart" id="empty-message">Ваша корзина пуста.</p>
    </div>
	<button id="checkout-button" class="checkout-button" onclick="window.location.href='korzina.html'" disabled>
	    Оформить заказ
	</button>

    <h2>Каталог растений</h2>
	<div id="product-catalog">
        <div class="catalog-tabs" id="catalog-tabs">
            <button type="button" class="catalog-tab-button active" data-gid="727164352">ВЕСНА</button>
            <button type="button" class="catalog-tab-button" data-gid="703775930">ЛЕТО</button>
            <button type="button" class="catalog-tab-button" data-gid="212517103">ОСЕНЬ</button>
        </div>
        <div class="catalog-loading" id="catalog-loading">
            <img src="images/loading2.gif" alt="Загрузка...">
        </div>
        <div class="catalog-panels" id="catalog-panels">
            <div class="catalog-tab-panel" data-gid="727164352" style="display: block;">
                <div class="catalog-table"></div>
            </div>
            <div class="catalog-tab-panel" data-gid="703775930" style="display: none;">
                <div class="catalog-table"></div>
            </div>
            <div class="catalog-tab-panel" data-gid="212517103" style="display: none;">
                <div class="catalog-table"></div>
            </div>
        </div>
    </div>

    <script>
        const SHEETS = [
            { title: 'ВЕСНА', gid: '727164352' },
            { title: 'ЛЕТО', gid: '703775930' },
            { title: 'ОСЕНЬ', gid: '212517103' },
        ]
        const SHEETS_HTML_URL = 'https://docs.google.com/spreadsheets/u/0/d/e/2PACX-1vQb5BPZlW4dBNxs_dlAa1myvkuMSCB6NY23yR6BlAvNPY3J0Z3Oy7zh0Ngqo8cLGfcJveCgYo6OzVdk/pubhtml/sheet?headers=false&gid=';

const PROXY = 'https://script.google.com/macros/s/AKfycbyjdFe7Cb0IrdXxADFDJb1FgPZvoUgsag1sOwQG6TPxjcNy0BAiuqJZ7zlCczHphAAq/exec?url=';

function cleanImageUrl(url) {
  // удаляем =w###-h###, но сохраняем всё после (например, ?key=...)
  return url.replace(/=w\d+-h\d+/i, '');
}

function jsonp(url){
  return new Promise((resolve, reject)=>{
    const cb = 'cb_' + Math.random().toString(36).slice(2);
    const s = document.createElement('script');
    window[cb] = (data)=>{ resolve(data); delete window[cb]; s.remove(); };
    s.onerror = reject;
    s.src = url + '&callback=' + cb;
    document.head.appendChild(s);
  });
}

// после вставки таблицы:
/* TOOD: remove?
async function replaceImagesWithProxy(container){
  const imgs = Array.from(container.querySelectorAll('img'));
  const batch = 3; const sleep = ms => new Promise(r=>setTimeout(r,ms));
  for (let i=0;i<imgs.length;i+=batch){
    await Promise.all(imgs.slice(i,i+batch).map(async (img)=>{
      const src = img.getAttribute('data-src') || img.src; // исходный lh3
      img.removeAttribute('src'); img.loading='lazy';
      try{
        origSizeImg = cleanImageUrl(src);
        const j = await jsonp(PROXY + encodeURIComponent(origSizeImg));
        if (j && j.dataUrl) img.src = j.dataUrl;
      } catch(_){
        img.alt='load error'; img.style.outline='2px solid red';
      }
    }));
    await sleep(150);
  }
}
*/

function loadCatalog() {
    const container = document.getElementById('product-catalog');
    if (!container) {
        return;
    }

    const tabsBar = container.querySelector('.catalog-tabs');
    const panelsContainer = container.querySelector('.catalog-panels');
    const loadingEl = container.querySelector('#catalog-loading') || container.querySelector('.catalog-loading');

    if (!tabsBar || !panelsContainer) {
        return;
    }

    const tabButtons = [];
    const tabPanels = [];
    const loadPromises = [];

    SHEETS.forEach(({ title, gid }, index) => {
        let tabButton = tabsBar.querySelector(`.catalog-tab-button[data-gid="${gid}"]`);
        if (!tabButton) {
            tabButton = document.createElement('button');
            tabButton.type = 'button';
            tabButton.className = 'catalog-tab-button';
            tabButton.dataset.gid = gid;
            tabsBar.appendChild(tabButton);
        }
        tabButton.textContent = title;

        let subCatalog = panelsContainer.querySelector(`.catalog-tab-panel[data-gid="${gid}"]`);
        if (!subCatalog) {
            subCatalog = document.createElement('div');
            subCatalog.className = 'catalog-tab-panel';
            subCatalog.dataset.gid = gid;
            panelsContainer.appendChild(subCatalog);
        }

        subCatalog.style.display = index === 0 ? 'block' : 'none';
        tabButton.classList.toggle('active', index === 0);

        let tableDiv = subCatalog.querySelector('.catalog-table');
        if (!tableDiv) {
            tableDiv = document.createElement('div');
            tableDiv.className = 'catalog-table';
            subCatalog.appendChild(tableDiv);
        } else {
            tableDiv.innerHTML = '';
        }

        tabButton.onclick = () => {
            tabPanels.forEach(panel => {
                panel.style.display = 'none';
            });
            tabButtons.forEach(button => {
                button.classList.remove('active');
            });
            subCatalog.style.display = 'block';
            tabButton.classList.add('active');
        };

        tabButtons.push(tabButton);
        tabPanels.push(subCatalog);

        loadPromises.push(loadSubCatalog(tableDiv, title, gid));
    });

    const finalizeLoading = () => {
        if (loadingEl) {
            loadingEl.remove();
        }
    };

    if (loadPromises.length > 0) {
        Promise.allSettled(loadPromises).finally(finalizeLoading);
    } else {
        finalizeLoading();
    }
}

function loadSubCatalog(tableDiv, title, gid) {
    const SHEET_URL = SHEETS_HTML_URL + gid;
    return fetch(SHEET_URL, { cache: 'no-store' })
        .then(r => r.text())
        .then(data => {
            //console.log('Fetched catalog data:\n', data);

            const match = data.match(/<table[\s\S]*?<\/table>/i);
            if (!match) throw new Error('Таблица ' + title + ' не найдена');

            tableDiv.innerHTML = match[0];

            //replaceImagesWithProxy(container);

            addBuyButtons(tableDiv);
        })
        .catch(e => {
            console.error('Ошибка загрузки каталога', title, e);
            tableDiv.textContent = 'Ошибка загрузки каталога ' + title;
        });
}

		function addBuyButtons(subCatalog) {
		    const rows = Array.from(subCatalog.querySelectorAll('table tr'));

            // rows[0] is all empty 🤷‍♀️
            if (rows[0]) {
                const firstRow = rows[0];
                firstRow.remove(); // strip the empty row from the table
                rows.shift(); // from the array too.
            }

		    rows.forEach((row, index) => {
		        const cells = row.querySelectorAll('td');

                 // для заголовков разделов - меняем colspan=5 на colspan=6
		        const firstCell = cells[0];
		        if (firstCell.hasAttribute('colspan') && firstCell.getAttribute('colspan') === '5') {
		            firstCell.setAttribute('colspan', '6');
		            return;
		        }

		        // Добавляем текст "Купить" в заголовке
		        if (index === 0) {
		            const buyHeaderCell = document.createElement('td');
                    buyHeaderCell.className = 's0';
		            buyHeaderCell.textContent = 'Купить';
		            row.appendChild(buyHeaderCell);
		            return;
		        }

		        // Проверяем, содержит ли вторая колонка числовой код и пятая колонка цену (или слово НЕТ)
		        const codeCell = cells[1];
		        const priceCell = cells[4];
		        const buyCell = document.createElement('td'); // Создаем ячейку для кнопки или пустоты

		        const isCodeValid = codeCell && /^[0-9]+$/.test(codeCell.textContent.trim());
		        const isPriceValid = priceCell && /\d+/.test(priceCell.textContent.trim());

		        if (isCodeValid && isPriceValid) {
		            const quantityInput = document.createElement('input');
		            quantityInput.type = 'number';
		            quantityInput.value = '1';
		            quantityInput.min = '1';
		            quantityInput.className = 'quantity-input';

		            const buyButton = document.createElement('button');
		            buyButton.textContent = 'Добавить';
		            buyButton.className = 'add-to-cart';
		            buyButton.onclick = function () {
		                // Заменяем содержимое ячейки на текст "✅ Добавлено"
		                buyCell.innerHTML = '<span class="added">✅ Добавлено</span>';
		                addToCartFromRow(row, quantityInput.value);
		            };

		            buyCell.appendChild(quantityInput);
		            buyCell.appendChild(buyButton);
		        }

		        row.appendChild(buyCell); // Добавляем ячейку в любом случае
		    });
		}

		function addToCartFromRow(row, quantity) {
		    const cells = row.querySelectorAll('td');
		    const photo = cells[0].innerHTML;
		    const code = cells[1].textContent;
		    const name = cells[2].textContent;
		    const price = cells[4].textContent;

		    const cart = JSON.parse(localStorage.getItem('cart')) || {};

		    if (cart[code]) {
		        cart[code].quantity += parseInt(quantity);
		    } else {
		        cart[code] = { photo, name, price, quantity: parseInt(quantity) };
		    }

		    localStorage.setItem('cart', JSON.stringify(cart));
		    // alert(`Товар ${name} добавлен в корзину`);
			loadCart();
		}

        function loadCart() {
            const cart = JSON.parse(localStorage.getItem('cart')) || {};
            const cartTableBody = document.querySelector('#cart-table tbody');
            const emptyMessage = document.getElementById('empty-message');
		    const checkoutButton = document.getElementById('checkout-button');

            // Clear the cart display
            cartTableBody.innerHTML = '';

            if (Object.keys(cart).length === 0) {
                emptyMessage.style.display = 'block';
		        checkoutButton.disabled = true; // Отключаем кнопку "Оформить заказ"
                return;
            }

            emptyMessage.style.display = 'none';
		    checkoutButton.disabled = false; // Активируем кнопку "Оформить заказ"

            Object.entries(cart).forEach(([code, item]) => {
                const row = document.createElement('tr');

                const photoCell = document.createElement('td');
                photoCell.innerHTML = item.photo;
                row.appendChild(photoCell);

                const codeCell = document.createElement('td');
                codeCell.textContent = code;
                row.appendChild(codeCell);

                const nameCell = document.createElement('td');
                nameCell.textContent = item.name;
                row.appendChild(nameCell);

                const priceCell = document.createElement('td');
                priceCell.textContent = item.price;
                row.appendChild(priceCell);

                const quantityCell = document.createElement('td');
                const quantityInput = document.createElement('input');
                quantityInput.type = 'number';
                quantityInput.value = item.quantity;
                quantityInput.min = '1';
                quantityInput.className = 'quantity';
                quantityInput.addEventListener('change', () => updateQuantity(code, quantityInput.value));
                quantityCell.appendChild(quantityInput);
                row.appendChild(quantityCell);

                const actionCell = document.createElement('td');
                const removeButton = document.createElement('button');
                removeButton.textContent = 'Удалить';
                removeButton.className = 'remove-item';
                removeButton.addEventListener('click', () => removeItem(code));
                actionCell.appendChild(removeButton);
                row.appendChild(actionCell);

                cartTableBody.appendChild(row);
            });
        }

        function updateQuantity(code, newQuantity) {
            const cart = JSON.parse(localStorage.getItem('cart')) || {};
            cart[code].quantity = parseInt(newQuantity);
            localStorage.setItem('cart', JSON.stringify(cart));
        }

        function removeItem(code) {
            const cart = JSON.parse(localStorage.getItem('cart')) || {};
            delete cart[code];
            localStorage.setItem('cart', JSON.stringify(cart));
            loadCart();
        }
		
        function toggleCart() {
            const cartContainer = document.getElementById('cart-container');
            const toggleButton = document.querySelector('.toggle-button');

            if (cartContainer.style.display === 'none' || cartContainer.style.display === '') {
                cartContainer.style.display = 'block';
                toggleButton.textContent = 'Свернуть корзину';
            } else {
                cartContainer.style.display = 'none';
                toggleButton.textContent = 'Развернуть корзину';
            }
        }

		window.onload = function () {
		    loadCart();
		    loadCatalog();
		};
    </script>
</td>
</tr>
</table>
</body>
</html>
