<meta http-equiv=Content-Type content="text/html; charset=UTF-8">

<script>
console.log("Hello, world!");

// const SOURCE_URL = "http://localhost:8000/price_1_short.html";

// TODO: code below duplicates AppsScript/Upload.gs !!

const SOURCE_URL = "https://kodekur.ru/price_1_short.html";

function loadTable() {
  fetchUrl(SOURCE_URL)
    .then(html => {
      console.log(html);

      const rows = extractTableRows(html);
      if (!rows.length) {
        console.warn('Таблица не найдена или пуста.');
        return;
      }

      console.log('Parsed rows:', rows);
      writeRowsToSheet(rows);
    })
    .catch(error => {
      console.error('Не удалось загрузить таблицу:', error);
    });
}

async function fetchUrl(url) {
  if (typeof UrlFetchApp !== 'undefined' && typeof UrlFetchApp.fetch === 'function') {
    const response = UrlFetchApp.fetch(url, { muteHttpExceptions: true });
    return response.getContentText();
  }

  const res = await fetch(url);
  return res.text();
}

function extractTableRows(html) {
  return parseTableRowsForAppsScript(html);
}

function parseTableRowsForAppsScript(html) {
  if (typeof html !== 'string' || !html) return [];

  const tableMatch = html.match(/<table[\s\S]*?<\/table>/i);
  if (!tableMatch) return [];

  const tableHtml = tableMatch[0];
  const rows = [];
  const rowRegex = /<tr[\s\S]*?<\/tr>/gi;
  let rowMatch;

  while ((rowMatch = rowRegex.exec(tableHtml))) {
    const rowHtml = rowMatch[0];
    const cells = [];
    const cellRegex = /<(?:td|th)[\s\S]*?>([\s\S]*?)<\/(?:td|th)>/gi;
    let cellMatch;

    while ((cellMatch = cellRegex.exec(rowHtml))) {
      const cellHtml = cellMatch[1];
      const imgMatch = cellHtml.match(/<img[^>]+src=["']?([^"'>\s]+)/i);

      if (imgMatch) {
        cells.push(imgMatch[1]);
        continue;
      }

      const text = decodeHtmlEntities(stripHtml(cellHtml));
      cells.push(text);
    }

    if (cells.length) {
      rows.push(cells);
    }
  }

  return rows;
}

function decodeHtmlEntities(value) {
  if (!value) return '';

  const entities = {
    '&nbsp;': ' ',
    '&amp;': '&',
    '&lt;': '<',
    '&gt;': '>',
    '&quot;': '"',
    '&#39;': "'"
  };

  return value.replace(/&(?:[a-zA-Z]+|#\d+);/g, entity => {
    if (entities[entity]) return entities[entity];
    const numeric = entity.match(/&#(\d+);/);
    if (numeric) {
      const codePoint = Number(numeric[1]);
      if (Number.isFinite(codePoint)) {
        return String.fromCharCode(codePoint);
      }
    }
    return entity;
  });
}

function stripHtml(value) {
  if (!value) return '';
  return value
    .replace(/<br\s*\/?>/gi, '\n')
    .replace(/<\/(p|div|tr|table|thead|tbody|tfoot|li)>/gi, '\n')
    .replace(/<[^>]+>/g, '');
}

function writeRowsToSheet(rawRows) {
  const rows = normalizeRows(rawRows);
  console.log('Normalized rows:', rows);

  if (!rows.length) {
    console.warn('Нет данных для записи в таблицу.');
  }

  if (!canUseSpreadsheetApi()) {
    console.info('SpreadsheetApp недоступен. Данные выведены в консоль.');
    console.table(rows.map(row => row.values));
    return;
  }  

  const header = [["Фото", "Код", "Наименование", "Описание", "Цена, руб."]];
  const targetSheetName = "Импорт";
  const spreadsheet = SpreadsheetApp.getActive();
  const sheet = spreadsheet.getSheetByName(targetSheetName) || spreadsheet.insertSheet(targetSheetName);

  const columnsCount = header[0].length;
  const values = rows.map(row => row.values);

  sheet.clearContents();
  sheet.getRange(1, 1, sheet.getMaxRows(), columnsCount).breakApart();
  sheet.getRange(1, 1, 1, columnsCount).setValues(header);

  if (rows.length) {
    sheet.getRange(2, 1, rows.length, columnsCount).setValues(values);
    rows.forEach((row, index) => {
      if (row.mergeAcross) {
        const rowNumber = index + 2; // +2 because header is on the first row
        sheet.getRange(rowNumber, 1, 1, columnsCount).mergeAcross();
      }
    });
  }
  console.log(`Записано ${rows.length} строк в лист "${targetSheetName}".`);
}

function canUseSpreadsheetApi() {
  return typeof SpreadsheetApp !== 'undefined' &&
    SpreadsheetApp &&
    typeof SpreadsheetApp.getActive === 'function';
}

function normalizeRows(rawRows) {
  if (!Array.isArray(rawRows)) return [];

  const normalized = [];

  for (const cells of rawRows) {
    if (!Array.isArray(cells) || !cells.length) continue;

    const trimmed = cells.map(sanitizeCellText);

    if (trimmed.length >= 4) {
      const [photoCell, codeCell, nameCell, priceCell] = trimmed;
      if (!isNumericCode(codeCell)) continue;

      const imgSrc = toAbsoluteSrc(photoCell);
      const imageFormula = imgSrc ? toImageFormula(imgSrc) : '';
      const rawName = collapseWhitespace(nameCell);
      const [name, description] = splitNameAndDescription(rawName);
      const code = collapseWhitespace(codeCell);
      const price = priceCell;

      if (!code || price === null) continue;
      normalized.push({
        values: [imageFormula, code, name, description, price],
        mergeAcross: false
      });
      continue;
    }

    if (trimmed.length === 1) {
      const sectionTitle = collapseWhitespace(trimmed[0]);
      // Записываем строку как merged cell (объединённая ячейка на 5 колонок)
      if (sectionTitle) {
        normalized.push({
          values: [sectionTitle, "", "", "", ""],
          mergeAcross: true
        });
      }
    }
  }

  return normalized;
}

function sanitizeCellText(value) {
  if (typeof value === 'string') return value;
  if (value == null) return '';
  return String(value);
}

function collapseWhitespace(value) {
  if (typeof value !== 'string') return '';
  return value
    .replace(/\u00A0/g, ' ')
    .replace(/\s*\n+\s*/g, ' ')
    .trim();
}

function splitNameAndDescription(value) {
  if (!value) return ['', ''];

    const commaIndex = value.indexOf(',');
    const dotIndex = value.indexOf('.');
    let delimiterIndex = -1;
    if (commaIndex !== -1 && dotIndex !== -1) {
        delimiterIndex = Math.min(commaIndex, dotIndex);
    } else if (commaIndex !== -1) {
        delimiterIndex = commaIndex;
    } else if (dotIndex !== -1) {
        delimiterIndex = dotIndex;
    }
  if (delimiterIndex === -1) return [value, ''];

  const namePart = value.slice(0, delimiterIndex);
  const descriptionPart = collapseWhitespace(value.slice(delimiterIndex + 1));
  // First letter to uppercase
  const descriptionPartFormatted = descriptionPart.charAt(0).toUpperCase() + descriptionPart.slice(1);
  return [collapseWhitespace(namePart), descriptionPartFormatted];
}

function isNumericCode(code) {
  return /\d/.test(code) && code.trim().length >= 3;
}

function hasNumeric(value) {
  return /\d/.test(value);
}

function toAbsoluteSrc(src) {
  const trimmed = collapseWhitespace(src);
  if (!trimmed) return '';

  const base = "https://kodekur.ru/"; 
  return base + trimmed.replace(/^\/+/, '');
}

function toImageFormula(url) {
  const sanitized = String(url).replace(/"/g, '""');
  return `=IMAGE("${sanitized}")`;
}


loadTable();

</script>
