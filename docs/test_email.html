
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Отправка письма с EmailJS</title>
	<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            padding: 0;
        }

        form {
            max-width: 400px;
            margin: auto;
        }

        label {
            display: block;
            margin-top: 10px;
        }

        input, textarea {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            box-sizing: border-box;
        }

        button {
            margin-top: 15px;
            padding: 10px;
            width: 100%;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }

        button:hover {
            background-color: #45a049;
        }

        #status {
            margin-top: 20px;
            text-align: center;
            font-size: 1.2em;
        }

        .success {
            color: green;
        }

        .error {
            color: red;
        }
    </style>
</head>
<body>

<h1>Отправка письма</h1>
<div id="status"></div>
<form id="emailForm">
    <label for="recipient">Email получателя:</label>
    <input type="email" id="recipient" name="recipient" required>

    <label for="message">Сообщение:</label>
    <textarea id="message" name="message" rows="4" required></textarea>

    <button type="submit">Отправить письмо</button>
</form>

<script type="text/javascript">
    // Инициализация EmailJS с вашим Public Key
	emailjs.init("i3HpqvdgITUgo3iv4");
	
	// Глобальный счетчик заказов в Upstash
	const UPSTASH_REST_API = "https://stirring-stud-43190.upstash.io/incr/orderCounter"; // URL счетчика и команда increment.
	const UPSTASH_AUTH_TOKEN = "Bearer Aai2AAIjcDFkZDc5N2FiNjQwMjE0Y2ZjYTM3NGEwOWI2ODAxODk4MXAxMA"; // Ваш токен авторизации

	// Функция для увеличения счетчика
	async function incrementCounter() {
	    const response = await fetch(UPSTASH_REST_API, {
	        method: "GET",
	        headers: {
	            Authorization: UPSTASH_AUTH_TOKEN,
	        },
	    });

	    const data = await response.json();
        console.log("Ответ сервера:", data);
	    if (response.ok) {
	        return data.result; // Возвращает новое значение счетчика
	    } else {
            console.error("Ошибка запроса к Upstash:", data.error);
	        throw new Error(data.error || "Ошибка при обращении к Upstash");
	    }
	}
	
	// Обработчик формы
    document.getElementById("emailForm").addEventListener("submit", function (e) {
        e.preventDefault(); // Предотвращаем перезагрузку страницы

		(async () => {
        	const recipient = document.getElementById("recipient").value;
    		const message = document.getElementById("message").value;
        	const statusDiv = document.getElementById("status");

        	// Очищаем сообщение о статусе
        	statusDiv.textContent = "";

			try {
		        // Увеличиваем счетчик и получаем номер заказа
		        const orderNumber = await incrementCounter();

		        // Формируем параметры письма
		        const params = {
		            reply_to: recipient,
					order_number: orderNumber,
		            message: message,
		        };

		        // Отправляем письмо через EmailJS с созданными там service_ID и template_ID
		        await emailjs.send("service_kodekur", "template_mq9u6qv", params);

		        statusDiv.textContent = `Письмо успешно отправлено! Заказ №${orderNumber}`;
		        statusDiv.className = "success";

		        // Очищаем поля ввода
		        document.getElementById("recipient").value = "";
		        document.getElementById("message").value = "";
		    } catch (error) {
		        console.error("Ошибка:", error);
		        statusDiv.textContent = "Ошибка при отправке письма: " + error.message;
		        statusDiv.className = "error";
            }
        })();
    });
</script>

</body>
</html>
